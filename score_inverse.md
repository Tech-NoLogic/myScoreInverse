# diffusion解决逆问题的思路
## 逆问题
* 已知一个观测值$y$，已知$y = Ax$，求解$x$的值
## diffusion
* 输入一系列$x_i$，训练一个去噪网络以此来得到$p(x)$
## diffusion解决逆问题
* 输入的是$y$，在论文里也就是CT/MRI的sinogram/k-space
* 要求输出$x$，在论文里也就是CT/MRI后得到的medical image
* 显然可以令$y = Ax$，A指的是CT/MRI对$x$做的一系列变化，已知$y$，要求$x$，是一个逆问题
* 已知$y$，要求$x$，我们可以先得到$p(x|y)$，然后在$p(x|y)$中采样一个$x$
* 但是diffusion是unconditional的，原文就想了一个办法“hijack”了原来的模型，将y的信息在采样的时候“incorporate”进去
* 具体步骤如下：
  1. 首先使用medical image数据集训练一个unconditional的diffusion，得到$p(x)$
  2. 要求$p(x|y)$，按diffusion的常规做法，先要求解一个随机过程$\{x_t|y\}$，但是这个不好求，不过$\{y_t|y\}$好求，其中$y_t=Ax_t+\alpha(t)\epsilon$。
      * 注：令$p(x_t|x_0)=N(x_t|\alpha(t)x_0,\beta^2(t)I)$，即$\alpha(t)x_0$是$p_{0->t}$的均值，$\beta(t)$是$p_{0->t}$的方差，他们两个都是超参数序列$b_t$的函数
      * 可以推出$p(y_t|y)=N(\alpha(t)y,\beta^2(t)A^2I)$，即p(y_t|y)的均值是$\alpha(t)y$，方差是$\beta(t)A$。可以令$\hat{y_t} = \alpha(t)y + \beta(t)Az$，则$\hat{y_t} \sim p(y_t|y)$，以下称$\hat{y_t}$为$y_t$的估计值。
  3. 接下来就是想办法把$\{y_t|y\}$的信息融入进去。为此，我们在逆过程，也就是采样的过程中(特指$x_t->x_{t-1}$的过程)。
      * 首先，进行一个“proximal optimization step”，即近似的优化步骤：
        * 目标是得到一个$\hat{x_t}'$，以下称为优化后的$x_t$的估计值
        * $x_t$的估计值的优化是指：使之与$x_t$的估计值以及做变换$A$后能变成$y_t$的估计值的$x$的距离在一个超参数$\lambda$的约束下达到最短。
        * 数学上来说也就是：优化后的$x_t$的估计值是$N$维空间的一点，$x_t$的估计值也是$N$维空间的一点，做变换$A$后能得到$y_t$的估计值的点$x$构成一个$N-1$维的超平面。我们要达到在超参数$\lambda$的控制下的点点距离和点面距离的加权和最小。
        * 论文认为变换$A$可以拆分成两步变换，第一步是进行一个可逆的变换（CT中是randon变换；MRI中是傅里叶变换），然后再进行一个下采样。也就是将$A$拆成了两个矩阵的乘积。
        * 最后通过将$A$进行矩阵分解，可以将优化的式子化简为一个确定的表达式。就可以很简单的得到优化后的$x_t$的估计值。
      * 然后，按照diffusion的常规做法，先将优化后$x_t$的估计值和$t$输入unet，估计出第$t$步加上的噪声值，然后根据公式算出$x_{t-1}$的估计值。